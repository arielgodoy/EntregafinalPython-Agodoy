{% extends "partials/base.html" %}
{% load static %}

{% block title %}
Proyectos
{% endblock title %}

{% block pagetitle %}
{% include "partials/page-title.html" with title="Proyectos" pagetitle="Control de Proyectos" %}
{% endblock pagetitle %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row mb-3">
                <div class="col-md-6">
                    <h4 class="fw-bold">Proyectos</h4>
                </div>
                <div class="col-md-6 text-end">
                    <a href="{% url 'control_de_proyectos:crear_proyecto' %}" class="btn btn-primary">
                        <i class="bx bx-plus"></i> Nuevo Proyecto
                    </a>
                </div>
            </div>

            {% if proyectos %}
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-lg mb-5 rounded">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cliente</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Empresa</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for proyecto in proyectos %}
                                    <tr>
                                        <td><strong>{{ proyecto.nombre }}</strong></td>
                                        <td>{{ proyecto.cliente.nombre }}</td>
                                        <td><span class="badge bg-info">{{ proyecto.tipo_ref.nombre }}</span></td>
                                        <td>
                                            <span class="badge bg-{% if proyecto.estado == 'TERMINADO' %}success{% elif proyecto.estado == 'EN_EJECUCION' %}warning{% elif proyecto.estado == 'EN_COTIZACION' %}primary{% else %}secondary{% endif %}">
                                                {{ proyecto.get_estado_display }}
                                            </span>
                                        </td>
                                        <td>{{ proyecto.empresa_interna.codigo }}</td>
                                        <td>
                                            <a href="{% url 'control_de_proyectos:detalle_proyecto' proyecto.pk %}" class="btn btn-sm btn-info" title="Ver">
                                                <i class="bx bx-eye"></i>
                                                <span class="ms-1 d-none d-md-inline">Ver</span>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-secondary btn-toggle-tareas" data-target="tareas-{{ proyecto.id }}" aria-expanded="false" title="Tareas">
                                                <i class="bx bx-list-ul"></i>
                                                <span class="ms-1 d-none d-md-inline">Tareas</span>
                                            </button>
                                            <a href="{% url 'control_de_proyectos:editar_proyecto' proyecto.pk %}" class="btn btn-sm btn-warning" title="Editar">
                                                <i class="bx bx-edit"></i>
                                                <span class="ms-1 d-none d-md-inline">Editar</span>
                                            </a>
                                        </td>
                                    </tr>
                                    <tr id="tareas-{{ proyecto.id }}" class="tareas-row d-none">
                                        <td colspan="6">
                                            {% if proyecto.tareas.all %}
                                            <div class="accordion" id="acordeonTareas-{{ proyecto.id }}">
                                                {% for tarea in proyecto.tareas.all %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed tarea-accordion-button" type="button" data-target="#tarea-{{ tarea.id }}" aria-expanded="false" aria-controls="tarea-{{ tarea.id }}">
                                                            <div class="w-100 d-flex justify-content-between align-items-center">
                                                                <span class="fw-bold">{{ tarea.nombre }}</span>
                                                                <div class="ms-auto d-flex gap-2 align-items-center">
                                                                    <span class="badge bg-secondary">{{ tarea.get_estado_display }}</span>
                                                                    <span class="badge bg-{% if tarea.prioridad == 'URGENTE' %}danger{% elif tarea.prioridad == 'ALTA' %}warning{% else %}info{% endif %}">{{ tarea.get_prioridad_display }}</span>
                                                                    <small class="text-muted">{{ tarea.fecha_termino_estimada|default:"-" }}</small>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    </h2>
                                                    <div id="tarea-{{ tarea.id }}" class="accordion-collapse collapse">
                                                        <div class="accordion-body">
                                                            <p class="mb-1"><strong>Profesional:</strong> {{ tarea.profesional_asignado.nombre|default:"Sin asignar" }}</p>
                                                            <p class="mb-0"><strong>Descripción:</strong> {{ tarea.descripcion|default:"Sin descripción" }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="text-muted">Sin tareas registradas.</div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="text-muted">Sin tareas registradas.</div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">No hay proyectos registrados.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();

        const toggleButtons = document.querySelectorAll('.btn-toggle-tareas');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = button.getAttribute('data-target');
                if (!targetId) return;

                const row = document.getElementById(targetId);
                if (!row) return;

                const isHidden = row.classList.contains('d-none');
                row.classList.toggle('d-none', !isHidden);
                button.setAttribute('aria-expanded', String(isHidden));
            });
        });

        const tareaButtons = document.querySelectorAll('.tarea-accordion-button');
        tareaButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetSelector = button.getAttribute('data-target');
                if (!targetSelector) return;

                const targetElement = document.querySelector(targetSelector);
                if (!targetElement) return;

                const isOpen = targetElement.classList.contains('show');
                const accordion = button.closest('.accordion');
                if (!isOpen && accordion) {
                    const openItems = accordion.querySelectorAll('.accordion-collapse.show');
                    openItems.forEach(openEl => {
                        if (openEl === targetElement) return;
                        openEl.classList.remove('show');
                        const openButton = accordion.querySelector(`[data-target="#${openEl.id}"]`);
                        if (openButton) {
                            openButton.classList.add('collapsed');
                            openButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                }

                targetElement.classList.toggle('show', !isOpen);
                button.classList.toggle('collapsed', isOpen);
                button.setAttribute('aria-expanded', String(!isOpen));
            });
        });
    });
</script>
{% endblock extra_js %}
