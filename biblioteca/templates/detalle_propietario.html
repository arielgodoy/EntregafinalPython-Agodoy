{% extends "partials/base.html" %}
{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Toastify CSS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock extra_css %}


{% block title %}
Detalle de Propietario
{% endblock title %}

{% block content %}
{% block pagetitle %}
{% include "partials/page-title.html" with title="Detalle de Propietario" pagetitle="Propietarios" %}
{% endblock pagetitle %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

<!-- Modal de confirmación reutilizable para eliminación de propiedad -->
<div class="modal fade" id="deletePropiedadModal" tabindex="-1" aria-labelledby="deletePropiedadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePropiedadModalLabel" data-key="confirm_delete">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p data-key="biblioteca.propiedad.delete_confirmation">¿Estás seguro de que deseas eliminar la propiedad <strong id="propiedadRol"></strong>?</p>
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong data-key="warning">Advertencia:</strong>
                    <span data-key="delete_warning">Esta acción es irreversible.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-key="cancel">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePropiedad" data-key="delete">Eliminar</button>
            </div>
        </div>
    </div>
</div>

{# extra_js removed from here; scripts consolidated at the end of the template #}
                <p><strong>Rol:</strong> {{ propietario.get_rol_display }}</p>
            </div>

<!-- Hidden csrf token form for JS to pick up token reliably -->
<form id="_csrf_form" style="display:none;">
    {% csrf_token %}
</form>

            <div class="card shadow-lg p-4 mt-4 rounded">
                <h2 class="mb-4">Propiedades asociadas:</h2>
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Listado de Propiedades</h5>
                    <a href="{% url 'biblioteca:crear_propiedad' propietario.id %}" class="btn btn-success">Agregar Propiedad</a>
                </div>
                <div class="table-responsive">
                    <table id="tabla-propiedades" class="table table-bordered dt-responsive nowrap table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Rol</th>
                                <th>Dirección</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for propiedad in propietario.propiedad_set.all %}
                            <tr id="propiedad-row-{{ propiedad.pk }}">
                                <td>{{ propiedad.rol }}</td>
                                <td>{{ propiedad.direccion }}</td>
                                <td>
                                    <a href="{% url 'biblioteca:detalle_propiedad' propiedad.pk %}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>
                                    <button type="button" class="btn btn-danger btn-sm btn-eliminar-propiedad"
                                            data-propiedad-id="{{ propiedad.pk }}"
                                            data-propiedad-rol="{{ propiedad.rol }}"
                                            data-delete-url="{% url 'biblioteca:eliminar_propiedad' propiedad.pk %}">
                                        <i class="bi bi-trash"></i> <span data-key="delete">Eliminar</span>
                                    </button>
                                    <a href="{% url 'biblioteca:modificar_propiedad' propiedad.pk %}" class="btn btn-warning btn-sm">
                                        <i class="bi bi-pencil"></i> Modificar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicializar DataTable
    if (window.jQuery && $.fn.DataTable) {
        $('#tabla-propiedades').DataTable({
            language: { url: '/static/lang/es-ES.json' },
            responsive: true,
            autoWidth: false,
        });
    }

    // Lógica del modal de eliminación
    const deleteModalEl = document.getElementById('deletePropiedadModal');
    const deleteModal = deleteModalEl ? new bootstrap.Modal(deleteModalEl) : null;
    const confirmBtn = document.getElementById('confirmDeletePropiedad');
    let deleteUrl = '';
    let propiedadId = '';

    document.querySelectorAll('.btn-eliminar-propiedad').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            propiedadId = this.getAttribute('data-propiedad-id');
            deleteUrl = this.getAttribute('data-delete-url');
            const rol = this.getAttribute('data-propiedad-rol');
            const rolEl = document.getElementById('propiedadRol');
            if (rolEl) rolEl.textContent = rol;
            if (deleteModal) deleteModal.show();
        });
    });

    if (confirmBtn) {
        confirmBtn.addEventListener('click', function () {
            if (!deleteUrl) return;
            confirmBtn.disabled = true;
            const originalText = confirmBtn.textContent;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (originalText || 'Eliminando...');

            const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]') ? document.querySelector('input[name=csrfmiddlewaretoken]').value : getCookie('csrftoken');

            fetch(deleteUrl, {
                method: 'POST',
                credentials: 'same-origin',
                redirect: 'manual',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken,
                    'Accept': 'application/json'
                }
            }).then(r => {
                // Manejo de redirecciones: no forzamos reload automático
                if (r.status === 302 || r.redirected) {
                    const location = r.headers.get('Location');
                    if (window.Toastify) {
                        Toastify({ text: 'Sesión expirada o redirección del servidor', duration: 3000, gravity: 'top', position: 'right', backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'}).showToast();
                    }
                    if (location) {
                        // seguir la redirección del servidor (login u otra página)
                        setTimeout(function(){ window.location.href = location; }, 900);
                    }
                    return Promise.reject(new Error('redirect'));
                }
                const ct = r.headers.get('Content-Type') || '';
                if (ct.indexOf('application/json') === -1) {
                    // Intentar leer texto de error y mostrarlo en toast sin recargar
                    return r.text().then(text => {
                        const message = text ? (text.length > 300 ? text.slice(0,300) + '...' : text) : 'Respuesta inesperada del servidor';
                        if (window.Toastify) Toastify({ text: message, duration: 5000, gravity: 'top', position: 'right', backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'}).showToast();
                        return Promise.reject(new Error('not-json'));
                    });
                }
                return r.json();
            }).then(data => {
                if (data && data.success) {
                    // remove row by id
                    if (propiedadId) {
                        const node = document.getElementById('propiedad-row-' + propiedadId);
                        if (node && node.remove) node.remove();
                    }
                    if (window.Toastify) {
                        Toastify({ text: data.message || 'Eliminado', duration: 3000, gravity: 'top', position: 'right', backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)'}).showToast();
                    }
                } else {
                    const err = (data && data.error) ? data.error : 'Error al eliminar';
                    if (window.Toastify) Toastify({ text: err, duration: 3000, gravity: 'top', position: 'right', backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'}).showToast();
                }
            }).catch(err => {
                // Si la promesa fue rechazada por un redirect, ya recargamos.
                if (err && (err.message === 'redirect' || err.message === 'not-json')) return;
                if (window.Toastify) Toastify({ text: 'Error al eliminar', duration: 3000, gravity: 'top', position: 'right', backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'}).showToast();
            }).finally(() => {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
                if (deleteModal) deleteModal.hide();
                deleteUrl = '';
                propiedadId = '';
            });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock content %}
