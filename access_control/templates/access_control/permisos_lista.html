{% extends "partials/base.html" %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Toastify CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock extra_css %}

{% block title %}
Gestión de Permisos
{% endblock title %}

{% block pagetitle %}
{% include "partials/page-title.html" with title="Gestión de Permisos" pagetitle="Permisos" %}
{% endblock pagetitle %}

{% block content %}
<!-- ⚠️ TODO: Todos los textos visibles deben tener data-key para i18n -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title" data-key="permissions_management">Gestión de Permisos</h4>
                        <a href="{% url 'access_control:permiso_crear' %}" class="btn btn-success" data-key="create_new_permission">Crear Nuevo Permiso</a>
                    </div>

                    <div class="table-responsive">
                        <form id="csrf-form">{% csrf_token %}</form>
                        <table class="table table-bordered dt-responsive nowrap table-striped align-middle" id="permisos-table">
                            <thead>
                                <tr>
                                    <th data-key="user">Usuario</th>
                                    <th data-key="company">Empresa</th>
                                    <th data-key="view">Vista</th>
                                    <th class="text-center" data-key="perm_i">I</th>
                                    <th class="text-center" data-key="perm_c">C</th>
                                    <th class="text-center" data-key="perm_m">M</th>
                                    <th class="text-center" data-key="perm_e">E</th>
                                    <th class="text-center" data-key="perm_a">A</th>
                                    <th class="text-center" data-key="perm_s">S</th>
                                    <th data-key="actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for permiso in permisos %}
                                <tr id="permiso-row-{{ permiso.id }}">
                                    <td>{{ permiso.usuario.username }}</td>
                                    <td>{{ permiso.empresa.codigo }}</td>
                                    <td>{{ permiso.vista.nombre }}</td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.ingresar %}checked{% endif %} disabled>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.crear %}checked{% endif %} disabled>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.modificar %}checked{% endif %} disabled>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.eliminar %}checked{% endif %} disabled>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.autorizar %}checked{% endif %} disabled>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" {% if permiso.supervisor %}checked{% endif %} disabled>
                                    </td>
                                    <td>
                                        <a href="{% url 'access_control:permiso_editar' permiso.id %}" class="btn btn-primary btn-sm">
                                            <i class="bi bi-pencil"></i> <span data-key="edit">Editar</span>
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm btn-eliminar-permiso"
                                                data-permiso-id="{{ permiso.id }}"
                                                data-permiso-nombre="{{ permiso.usuario.username }} - {{ permiso.empresa.codigo }} - {{ permiso.vista.nombre }}"
                                                data-delete-url="{% url 'access_control:permiso_eliminar' permiso.id %}">
                                            <i class="bi bi-trash"></i> <span data-key="delete">Eliminar</span>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script>
    let permisoTable;
    let deleteUrl = '';
    let permisoId = '';

    document.addEventListener('DOMContentLoaded', function () {
        permisoTable = $('#permisos-table').DataTable({
            language: {
                url: "/static/lang/es-ES.json"
            },
            responsive: true,
            autoWidth: false,
        });

        // Click en botón eliminar (delegación)
        $(document).on('click', '.btn-eliminar-permiso', function(e) {
            e.preventDefault();
            permisoId = $(this).data('permiso-id');
            const permisoNombre = $(this).data('permiso-nombre');
            deleteUrl = $(this).data('delete-url');

            // Actualizar modal
            $('#permisoNombre').text(permisoNombre);

            // Mostrar modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModalPermiso'));
            deleteModal.show();
        });

        // Confirmar eliminación
        $('#confirmDeletePermiso').on('click', function() {
            if (!deleteUrl) return;
            const $btn = $(this);
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...');

            $.ajax({
                url: deleteUrl,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModalPermiso')).hide();
                    // Remover fila
                    try {
                        permisoTable.row('#permiso-row-' + permisoId).remove().draw();
                    } catch (err) {
                        // fallback: eliminar del DOM
                        $('#permiso-row-' + permisoId).remove();
                    }

                    Toastify({
                        text: response.message || "Eliminado exitosamente",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();
                },
                error: function(xhr) {
                    let errorMsg = 'Error al eliminar';
                    if (xhr.responseJSON && (xhr.responseJSON.error || xhr.responseJSON.message)) {
                        errorMsg = xhr.responseJSON.error || xhr.responseJSON.message;
                    }
                    Toastify({ text: errorMsg, duration: 3000, gravity: "top", position: "right", backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)" }).showToast();
                },
                complete: function() {
                    $btn.prop('disabled', false).text('Eliminar');
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- Modal de confirmación (ID único para permisos) -->
<div class="modal fade" id="deleteModalPermiso" tabindex="-1" aria-labelledby="deleteModalPermisoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalPermisoLabel" data-key="confirm_delete">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p data-key="delete_confirmation">¿Estás seguro de que deseas eliminar <strong id="permisoNombre"></strong>?</p>
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong data-key="warning">Advertencia:</strong>
                    <span data-key="delete_warning">Esta acción es irreversible.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-key="cancel">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePermiso" data-key="delete">Eliminar</button>
            </div>
        </div>
    </div>
</div>

{% endblock extra_js %}
