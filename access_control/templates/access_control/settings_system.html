{% extends "partials/base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="card shadow-lg p-4 mb-5 rounded bg-mode">
                <h1 class="mb-4 text-center">System Settings</h1>
                {% if messages %}
                <div class="mb-3">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                <form method="post" class="p-3">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                    <div class="text-danger">
                        {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% for field in form %}
                    <div class="form-group mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% for error in field.errors %}
                        <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% if puede_probar_email %}
                    <div class="form-group mb-3 text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <button type="button" class="btn btn-info w-10 mb-2" onclick="probarSalidaSistema()" data-key="btn-test-outgoing">Probar Correo de Salida</button>
                            <button type="button" class="btn btn-warning w-10 mb-2" onclick="enviarCorreoPruebaSistema()" data-key="btn-send-test">Enviar Correo de Prueba</button>
                        </div>
                    </div>
                    {% endif %}
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-success w-50 me-2">Guardar cambios</button>
                        <a href="{% url 'access_control:usuarios_lista' %}" class="btn btn-secondary w-50">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        feather.replace();
    });

    function mostrarToast(mensaje, success = true) {
        Toastify({
            text: mensaje,
            duration: 6000,
            gravity: "top",
            position: "right",
            offset: { x: 20, y: 100 },
            stopOnFocus: true,
            close: true,
            backgroundColor: success ? "#28a745" : "#dc3545"
        }).showToast();
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(';').shift();
        }
        return '';
    }

    function postSystemEmailTest(url, successMessage) {
        fetch(url, {
            method: "POST",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie('csrftoken'),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(res => mostrarToast(res.status === 'ok' ? successMessage : "‚ùå " + (res.detail || 'Error'), res.status === 'ok'))
        .catch(() => mostrarToast("‚ùå Error", false));
    }

    function probarSalidaSistema() {
        postSystemEmailTest("{% url 'access_control:system_config_test_outgoing' %}", "‚úÖ Salida OK");
    }

    function enviarCorreoPruebaSistema() {
        postSystemEmailTest("{% url 'access_control:system_config_send_test' %}", "üìß Correo enviado con √©xito");
    }
</script>
{% endblock extra_js %}
