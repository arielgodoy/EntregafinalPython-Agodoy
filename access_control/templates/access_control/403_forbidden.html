{% extends "partials/base.html" %}
{% load static %}
{% block extra_css %}
{% endblock extra_css %}

{% block title %}
Acceso Denegado
{% endblock title %}

{% block pagetitle %}
{% include "partials/page-title.html" with title="Acceso Denegado" pagetitle="Error 403" title_key="error_403_title" pagetitle_key="error_403_pagetitle" %}
{% endblock pagetitle %}

{% block content %}
<!-- ⚠️ TODO: Todos los textos visibles deben tener data-key para i18n -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="text-center">
                <h1 class="display-1 text-danger" data-key="error_403">403</h1>
                <p class="lead" data-key="error_403_message">No tienes permisos suficientes para acceder a esta página.</p>
                <p>
                    <span data-key="error_403_attempt">Intentaste acceder a la vista</span>
                    <strong>{{ vista_nombre }}</strong>
                    <span data-key="error_403_company">de la empresa</span>
                    <strong>{{ empresa_nombre }}</strong>.
                </p>
                <div class="d-inline-flex flex-wrap gap-2 justify-content-center">
                    <a href="javascript:history.back()" class="btn btn-primary" data-key="go_back">Volver</a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#accessRequestModal" data-key="access.request.button">Solicitar acceso</button>
                </div>
            </div>

            <div class="mt-4">
                <h5 data-key="access.request.history.title">Solicitudes pendientes para esta vista</h5>
                {% if pending_access_requests %}
                    <ul class="list-group">
                        {% for req in pending_access_requests %}
                            <li class="list-group-item">
                                <span data-key="access.request.history.item">Solicitud</span>
                                <span class="ms-1">{{ req.created_at|date:"Y-m-d H:i" }}</span>
                                <span class="ms-2" data-key="access.request.motivo.label">Motivo</span>:
                                <span class="ms-1">{{ req.motivo }}</span>
                                <div class="mt-2">
                                    <span data-key="access_request.email.label">Email</span>:
                                    {% if req.email_status == "SENT" %}
                                        <span data-key="access_request.email.sent">Enviado</span>
                                    {% elif req.email_status == "FAILED" %}
                                        <span data-key="access_request.email.failed">Falló</span>
                                    {% else %}
                                        <span data-key="access_request.email.na">Omitido</span>
                                    {% endif %}
                                </div>
                                <div class="mt-1">
                                    <span data-key="access_request.email.from">De</span>:
                                    {% if req.email_from %}
                                        <span class="text-muted">{{ req.email_from }}</span>
                                    {% else %}
                                        <span class="text-muted" data-key="access_request.email.na">Omitido</span>
                                    {% endif %}
                                </div>
                                <div class="mt-1">
                                    <span data-key="access_request.email.recipients">Destinatarios</span>:
                                    {% if req.email_recipients %}
                                        <span class="text-muted" title="{{ req.email_recipients }}">{{ req.email_recipients|truncatechars:120 }}</span>
                                    {% else %}
                                        <span class="text-muted" data-key="access_request.email.na">Omitido</span>
                                    {% endif %}
                                </div>
                                {% if req.email_status == "FAILED" and req.email_error %}
                                    <div class="text-muted small mt-1">
                                        <span data-key="access_request.email.error">Error</span>:
                                        <span>{{ req.email_error|truncatechars:120 }}</span>
                                    </div>
                                {% endif %}
                                {% if request.user.is_staff %}
                                    <div class="mt-2">
                                        <a href="{% url 'access_control:grant_access_request' req.id %}" class="btn btn-sm btn-outline-primary" data-key="access_request.history.grant_link">Otorgar acceso</a>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted" data-key="access.request.history.empty">No hay solicitudes pendientes.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="accessRequestModal" tabindex="-1" aria-labelledby="accessRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="access-request-form" method="post" action="{% url 'access_control:solicitar_acceso' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="accessRequestModalLabel" data-key="access.request.modal.title">Solicitar acceso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <span data-key="access.request.modal.context">Solicitas acceso a</span>
                        <strong>{{ vista_nombre }}</strong>
                        <span data-key="access.request.modal.context_company">de la empresa</span>
                        <strong>{{ empresa_nombre }}</strong>
                    </p>
                    <input type="hidden" name="vista_nombre" value="{{ vista_nombre }}">
                    <input type="hidden" name="empresa_id" value="{{ empresa_id|default:request.session.empresa_id }}">
                    <div class="mb-3">
                        <label for="motivo" class="form-label" data-key="access.request.motivo.label">Motivo</label>
                        <textarea id="motivo" name="motivo" class="form-control" rows="4" minlength="10" required placeholder="Describe el motivo" data-key="access.request.motivo.placeholder"></textarea>
                    </div>
                    {% if mail_enabled %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enviar_email" name="enviar_email">
                            <label class="form-check-label" for="enviar_email" data-key="access.request.email.option">Enviar por email a administradores</label>
                        </div>
                    {% else %}
                        <p class="text-muted" data-key="access.request.email.disabled">Tu usuario no tiene email configurado, se enviará solo notificación.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" data-key="access.request.submit">Enviar solicitud</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="d-none" aria-hidden="true">
    <span id="access-request-toast-ok" data-key="access.request.toast.ok">Solicitud enviada correctamente.</span>
    <span id="access-request-toast-dup" data-key="access.request.toast.dup">Ya enviaste una solicitud recientemente para esta vista.</span>
    <span id="access-request-toast-motivo-required" data-key="access.request.toast.motivo_required">El motivo es obligatorio (minimo 10 caracteres).</span>
    <span id="access-request-toast-error" data-key="access.request.toast.error">Ocurrio un error. Intenta nuevamente.</span>
    <span id="access-request-toast-email-failed" data-key="access.request.toast.email_failed">Solicitud enviada, pero el correo no pudo entregarse.</span>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/access_request.js' %}"></script>
{% endblock extra_js %}
