{% extends "partials/base.html" %}
<!-- ⚠️ TODO: Todos los textos visibles deben tener data-key para i18n -->

{% block extra_css %}
{% endblock extra_css %}

{% block title %}Gestión de Invitaciones{% endblock title %}

{% block pagetitle %}
{% include "partials/page-title.html" with title_key="invitations.title" pagetitle_key="menu.access_control" %}
{% endblock pagetitle %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="card shadow-lg p-4 mb-5 rounded bg-mode">
                <h1 class="mb-4 text-center" data-key="invitations.title">Gestion de Invitaciones</h1>

                <form method="get" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label for="estado" class="form-label" data-key="invitations.filters.status.label">Estado</label>
                        <select id="estado" name="estado" class="form-select">
                            <option value="active" {% if estado == 'active' %}selected{% endif %} data-key="invitations.filters.status.active">Activas</option>
                            <option value="expired" {% if estado == 'expired' %}selected{% endif %} data-key="invitations.filters.status.expired">Caducadas</option>
                            <option value="used" {% if estado == 'used' %}selected{% endif %} data-key="invitations.filters.status.used">Usadas</option>
                            <option value="all" {% if estado == 'all' %}selected{% endif %} data-key="invitations.filters.status.all">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="empresa" class="form-label" data-key="invitations.filters.company.label">Empresa</label>
                        <select id="empresa" name="empresa" class="form-select">
                            <option value="activa" {% if empresa_filtro == 'activa' %}selected{% endif %} data-key="invitations.filters.company.active">Empresa activa</option>
                            {% if user.is_staff %}
                            <option value="todas" {% if empresa_filtro == 'todas' %}selected{% endif %} data-key="invitations.filters.company.all">Todas</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" data-key="buttons.apply_filters">Aplicar filtros</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th data-key="invitations.table.email">Email</th>
                                <th data-key="invitations.table.username">Usuario</th>
                                <th data-key="invitations.table.type">Tipo</th>
                                <th data-key="invitations.table.status">Estado</th>
                                <th data-key="invitations.table.companies">Empresa(s)</th>
                                <th data-key="invitations.table.expires_at">Expira</th>
                                <th data-key="invitations.table.used_at">Usada</th>
                                <th data-key="invitations.table.actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in invitaciones %}
                            <tr id="invitation-row-{{ item.token.id }}">
                                <td>{{ item.token.user.email }}</td>
                                <td>{{ item.token.user.username }}</td>
                                <td data-key="invitations.type.activation">Activacion</td>
                                <td>
                                    {% if item.status_key == 'invitations.status.active' %}
                                    <span data-key="invitations.status.active">Activa</span>
                                    {% elif item.status_key == 'invitations.status.expired' %}
                                    <span data-key="invitations.status.expired">Caducada</span>
                                    {% else %}
                                    <span data-key="invitations.status.used">Usada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.is_global %}
                                    <span data-key="invitations.company.global">Global</span>
                                    {% else %}
                                        {% for empresa_label in item.empresas_labels %}
                                        <div>{{ empresa_label }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>{{ item.token.expires_at }}</td>
                                <td>{{ item.token.used_at|default_if_none:"" }}</td>
                                <td>
                                    <form method="post" action="{% url 'access_control:invitaciones_eliminar' item.token.id %}" class="delete-invitation-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm btn-eliminar-invitation" data-invitation-id="{{ item.token.id }}" data-delete-url="{% url 'access_control:invitaciones_eliminar' item.token.id %}" data-key="buttons.delete">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" data-key="invitations.empty">No hay invitaciones para mostrar.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-none" aria-hidden="true">
                    <span id="i18n-confirm-delete" data-key="invitations.delete.confirm">Confirmar eliminacion de la invitacion seleccionada.</span>
                    <span id="i18n-delete-success" data-key="invitations.delete.success">Invitacion eliminada.</span>
                    <span id="i18n-delete-error" data-key="invitations.delete.error">No se pudo eliminar la invitacion.</span>
                    {% if messages %}
                        {% for message in messages %}
                            {% if 'error' in message.tags %}
                            <span data-toast-error data-key="{{ message }}">{{ message }}</span>
                            {% else %}
                            <span data-toast-message data-key="{{ message }}">{{ message }}</span>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <!-- Modal de confirmación para eliminación (reutilizable) -->
                <div class="modal fade" id="deleteInvitationModal" tabindex="-1" aria-labelledby="deleteInvitationModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="deleteInvitationModalLabel" data-key="invitations.delete.confirm">Confirmar Eliminación</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p data-key="invitations.delete.confirm">¿Estás seguro de que deseas eliminar esta invitación?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-key="cancel">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteInvitation" data-key="delete">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const confirmText = document.getElementById('i18n-confirm-delete');
        const successText = document.getElementById('i18n-delete-success');
        const errorText = document.getElementById('i18n-delete-error');

        const forms = document.querySelectorAll('.delete-invitation-form');
        forms.forEach(form => {
            form.addEventListener('submit', function (event) {
                const message = confirmText ? confirmText.textContent : '';
                if (message && !window.confirm(message)) {
                    event.preventDefault();
                }
            });
        });

        const toastMessage = document.querySelector('[data-toast-message]');
        if (toastMessage && window.Toastify) {
            const message = toastMessage.textContent || '';
            if (message) {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: '#0ab39c',
                }).showToast();
            }
        }

        const toastError = document.querySelector('[data-toast-error]');
        if (toastError && window.Toastify) {
            const message = toastError.textContent || '';
            if (message) {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: '#f06548',
                }).showToast();
            }
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Variables para el modal
        let deleteUrl = '';
        let invitationId = '';

        const deleteModalEl = document.getElementById('deleteInvitationModal');
        const deleteModal = deleteModalEl ? new bootstrap.Modal(deleteModalEl) : null;
        const confirmBtn = document.getElementById('confirmDeleteInvitation');

        // Interceptar submit de formularios de eliminación para mostrar modal (mantiene fallback sin JS)
        document.querySelectorAll('.delete-invitation-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                // Sólo interceptar si existe el modal
                if (!deleteModal) return;

                e.preventDefault();

                const btn = form.querySelector('.btn-eliminar-invitation');
                invitationId = btn ? btn.getAttribute('data-invitation-id') : '';
                deleteUrl = btn ? btn.getAttribute('data-delete-url') : form.getAttribute('action');

                // Mostrar modal
                deleteModal.show();
            });
        });

        // Confirmación en modal: realizar AJAX POST
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function () {
                if (!deleteUrl) {
                    deleteModal.hide();
                    return;
                }

                // Botón con spinner
                confirmBtn.disabled = true;
                const originalText = confirmBtn.textContent;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (originalText || 'Eliminando...');

                // CSRF token (from any form on page)
                const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]') ? document.querySelector('input[name=csrfmiddlewaretoken]').value : getCookie('csrftoken');

                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json'
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data && data.success) {
                          // Quitar fila de la tabla si existe
                          if (invitationId) {
                              const row = document.getElementById('invitation-row-' + invitationId);
                              if (row && row.remove) row.remove();
                          }

                          // Toast de éxito
                          if (window.Toastify) {
                              Toastify({
                                  text: data.message || document.getElementById('i18n-delete-success').textContent || 'Eliminado',
                                  duration: 3000,
                                  gravity: 'top',
                                  position: 'right',
                                  backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)'
                              }).showToast();
                          }
                      } else {
                          const err = (data && data.error) ? data.error : document.getElementById('i18n-delete-error').textContent || 'Error al eliminar';
                          if (window.Toastify) {
                              Toastify({
                                  text: err,
                                  duration: 4000,
                                  gravity: 'top',
                                  position: 'right',
                                  backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                              }).showToast();
                          }
                      }
                  }).catch(err => {
                      if (window.Toastify) {
                          Toastify({
                              text: 'Error al eliminar',
                              duration: 4000,
                              gravity: 'top',
                              position: 'right',
                              backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                          }).showToast();
                      }
                  }).finally(() => {
                      // Restaurar botón y cerrar modal
                      confirmBtn.disabled = false;
                      confirmBtn.textContent = originalText;
                      if (deleteModal) deleteModal.hide();
                      deleteUrl = '';
                      invitationId = '';
                  });
            });
        }

        // Helper CSRF from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock extra_js %}
