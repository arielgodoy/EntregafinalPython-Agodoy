{% extends "partials/base.html" %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Toastify CSS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock extra_css %}

{% block title %}Invitar Usuario{% endblock title %}

{% block pagetitle %}
{% include "partials/page-title.html" with title_key="users.invite.title" pagetitle_key="menu.access_control" %}
{% endblock pagetitle %}

{% block content %}
<!-- ⚠️ TODO: Todos los textos visibles deben tener data-key para i18n -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="card shadow-lg p-4 mb-5 rounded bg-mode">
                <h1 class="mb-4 text-center" data-key="users.invite.title">Invitar Usuario</h1>
                <form method="post" class="p-3">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label" data-key="users.invite.email.label">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% for error in form.email.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ form.first_name.id_for_label }}" class="form-label" data-key="users.invite.first_name.label">{{ form.first_name.label }}</label>
                        {{ form.first_name }}
                        {% for error in form.first_name.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ form.last_name.id_for_label }}" class="form-label" data-key="users.invite.last_name.label">{{ form.last_name.label }}</label>
                        {{ form.last_name }}
                        {% for error in form.last_name.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ form.tipo_usuario.id_for_label }}" class="form-label" data-key="users.invite.user_type.label">{{ form.tipo_usuario.label }}</label>
                        <select name="{{ form.tipo_usuario.name }}" id="{{ form.tipo_usuario.id_for_label }}" class="form-control">
                            {% for value, label in form.tipo_usuario.field.choices %}
                            <option value="{{ value }}" {% if form.tipo_usuario.value == value %}selected{% endif %} data-key="users.invite.user_type.{{ value|lower }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        {% for error in form.tipo_usuario.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="form-group mb-3" id="usuario-referencia-field" data-users-url="{% url 'access_control:usuarios_por_empresas_json' %}">
                        <label for="{{ form.usuario_referencia.id_for_label }}" class="form-label" data-key="users.invite.reference_user.label">{{ form.usuario_referencia.label }}</label>
                        {{ form.usuario_referencia }}
                        {% for error in form.usuario_referencia.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                        {% if usuarios_referencia_vacios %}
                        <small class="text-muted" data-key="users.invite.reference_user.empty_help">No hay usuarios disponibles para copiar.</small>
                        {% endif %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ form.empresas.id_for_label }}" class="form-label" data-key="users.invite.companies.label">{{ form.empresas.label }}</label>
                        {{ form.empresas }}
                        {% for error in form.empresas.errors %}
                        <div class="text-danger" data-key="{{ error }}">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="d-none" aria-hidden="true">
                        <span id="i18n-loading-users" data-key="users.invite.loading_users">Cargando usuarios...</span>
                        <span id="i18n-no-users" data-key="users.invite.no_users">No hay usuarios disponibles.</span>
                        <span id="i18n-select-user" data-key="users.invite.select_user">Selecciona un usuario</span>
                    </div>
                    {% if form.non_field_errors %}
                    <div class="text-danger">
                        {% for error in form.non_field_errors %}
                        <p data-key="{{ error }}">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-success w-50 me-2" data-key="buttons.send_invitation">Enviar invitación</button>
                        <a href="{% url 'access_control:usuarios_lista' %}" class="btn btn-secondary w-50" data-key="buttons.cancel">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        feather.replace();

        const tipoUsuario = document.getElementById('{{ form.tipo_usuario.id_for_label }}');
        const usuarioReferenciaField = document.getElementById('usuario-referencia-field');
        const usuarioReferenciaInput = document.getElementById('{{ form.usuario_referencia.id_for_label }}');
        const empresasInput = document.getElementById('{{ form.empresas.id_for_label }}');
        const usersUrl = usuarioReferenciaField ? usuarioReferenciaField.dataset.usersUrl : '';
        const loadingText = document.getElementById('i18n-loading-users');
        const noUsersText = document.getElementById('i18n-no-users');
        const selectUserText = document.getElementById('i18n-select-user');

        function toggleReferencia() {
            const isUsuario = (tipoUsuario && tipoUsuario.value === 'USUARIO');
            if (!usuarioReferenciaField) {
                return;
            }
            usuarioReferenciaField.style.display = isUsuario ? 'block' : 'none';
            if (!isUsuario && usuarioReferenciaInput) {
                usuarioReferenciaInput.value = '';
            }
        }

        function buildEmpresaIds() {
            if (!empresasInput) {
                return [];
            }
            return Array.from(empresasInput.selectedOptions).map(option => option.value);
        }

        function setUsuarioReferenciaOptions(options, placeholderText) {
            if (!usuarioReferenciaInput) {
                return;
            }
            usuarioReferenciaInput.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = placeholderText || '';
            usuarioReferenciaInput.appendChild(placeholder);
            options.forEach(option => {
                usuarioReferenciaInput.appendChild(option);
            });
        }

        function loadUsuariosReferencia() {
            if (!usersUrl || !usuarioReferenciaInput) {
                return;
            }
            const empresaIds = buildEmpresaIds();
            const loadingLabel = loadingText ? loadingText.textContent : '';
            setUsuarioReferenciaOptions([], loadingLabel);

            const params = new URLSearchParams();
            if (empresaIds.length) {
                params.set('empresa_ids', empresaIds.join(','));
            }

            fetch(`${usersUrl}?${params.toString()}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
            })
                .then(response => response.json())
                .then(payload => {
                    const users = payload.users || [];
                    if (!users.length) {
                        const emptyLabel = noUsersText ? noUsersText.textContent : '';
                        setUsuarioReferenciaOptions([], emptyLabel);
                        return;
                    }

                    const options = users.map(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        const displayName = [user.first_name, user.last_name].filter(Boolean).join(' ');
                        const labelParts = [user.username];
                        if (displayName) {
                            labelParts.push(displayName);
                        }
                        if (user.email) {
                            labelParts.push(user.email);
                        }
                        option.textContent = labelParts.join(' - ');
                        return option;
                    });
                    const selectLabel = selectUserText ? selectUserText.textContent : '';
                    setUsuarioReferenciaOptions(options, selectLabel);
                })
                .catch(() => {
                    const emptyLabel = noUsersText ? noUsersText.textContent : '';
                    setUsuarioReferenciaOptions([], emptyLabel);
                });
        }

        if (tipoUsuario) {
            tipoUsuario.addEventListener('change', toggleReferencia);
        }
        if (empresasInput) {
            empresasInput.addEventListener('change', loadUsuariosReferencia);
        }
        toggleReferencia();
        loadUsuariosReferencia();
    });
</script>
{% endblock extra_js %}
